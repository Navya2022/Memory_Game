<html>
    <title>Sample Page</title>
    <head>
        <link rel="stylesheet" href="style2.css">
    </head>
    <body>
        <p><span id="matchCount">Matches: 0</span></p>
        <div id="cardsContainer" style="display:flex; flex-wrap:wrap; gap:20px;"></div>
    <script>
            window.onload = async () => {
                const stored = JSON.parse(sessionStorage.getItem("flashcards"));
                if (!stored || !Array.isArray(stored.questions) || stored.questions.length === 0) {
                    document.getElementById('cardsContainer').textContent = "No cards found â€” go back and add at least one question/answer pair.";
                    return;
                }

                // IndexedDB getter for blobs
                const openDB = () => new Promise((resolve, reject) => {
                    const req = indexedDB.open('memory-game-db', 1);
                    req.onupgradeneeded = e => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('images')) db.createObjectStore('images');
                    };
                    req.onsuccess = e => resolve(e.target.result);
                    req.onerror = e => reject(e.target.error);
                });

                const getBlobFromIDB = async (key) => {
                    const db = await openDB();
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction('images', 'readonly');
                        const store = tx.objectStore('images');
                        const req = store.get(key);
                        req.onsuccess = () => resolve(req.result);
                        req.onerror = e => reject(e.target.error);
                    });
                };

                // Build cards array; if content is idb:key for images, fetch blob and createObjectURL
                let cards = [];
                for (let i = 0; i < stored.questions.length; i++) {
                    const q = stored.questions[i];
                    const a = stored.answers[i];
                    if (!q || !a) continue;

                    let qContent = q.content;
                    if (q.type === 'image' && typeof qContent === 'string' && qContent.startsWith('idb:')) {
                        const key = qContent.slice(4);
                        const blob = await getBlobFromIDB(key);
                        qContent = blob ? URL.createObjectURL(blob) : null;
                    }

                    let aContent = a.content;
                    if (a.type === 'image' && typeof aContent === 'string' && aContent.startsWith('idb:')) {
                        const key = aContent.slice(4);
                        const blob = await getBlobFromIDB(key);
                        aContent = blob ? URL.createObjectURL(blob) : null;
                    }

                    if (qContent && aContent) {
                        cards.push({ role: "q", pair: i, type: q.type, content: qContent });
                        cards.push({ role: "a", pair: i, type: a.type, content: aContent });
                    }
                }

                for (let i = cards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [cards[i], cards[j]] = [cards[j], cards[i]];
                }

                const container = document.getElementById("cardsContainer");
                container.innerHTML = "";

                let openedCards = [];
                let lockBoard = false;
                matched = 0;

                cards.forEach(card => {
                    const div = document.createElement("div");
                    div.classList.add("flip-card");
                    div.dataset.type = card.type;
                    div.dataset.pair = card.pair;

                    let content;

                    if (card.type == "image") {
                        content = `<img src="${card.content}" style="width:100%; height:100%; object-fit:cover;">`;
                    } else {
                        content = `<p>${card.content}</p>`;
                    }

                    div.innerHTML = `
                        <div class="flip-card-inner">
                            <div class="flip-card-front">
                                <img src="component_images/card.png" style="width:100%; height:100%; object-fit:cover;">
                            </div>
                            <div class="flip-card-back">
                                <div class="back-text">
                                    ${content}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    div.addEventListener("click", () => {
                        if (lockBoard) return;
                        if (div.classList.contains("matched")) return;
                        if (openedCards.includes(div)) return;

                        div.classList.add("flipped");
                        openedCards.push(div);

                        if (openedCards.length === 2) {
                            lockBoard = true;
                            const [c1, c2] = openedCards;

                            if (c1.dataset.pair === c2.dataset.pair ) {
                                c1.classList.add("matched");
                                c2.classList.add("matched");
                                matched ++;
                                updateMatchCount(matched,stored.questions.length);
                            } else {
                                setTimeout(() => {
                                    c1.classList.remove("flipped");
                                    c2.classList.remove("flipped");
                                }, 1000);
                            }

                            openedCards = [];
                            lockBoard = false;
                        }
                    });

                    container.appendChild(div);
                });


            };
           
             
            function updateMatchCount(matched,len) {
                document.getElementById('matchCount').textContent = "Matched Pairs: " + matched + " / " + (len);
                if (matched === len){
                    window.location.href = "final_message.html";
                }
                 
            }


</script>

    </body>
</html>